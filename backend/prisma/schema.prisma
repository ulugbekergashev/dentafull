// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Doctor {
  id             String   @id @default(uuid())
  firstName      String
  lastName       String
  specialty      String
  phone          String
  email          String?
  status         String // 'Active' | 'On Leave'
  username       String?  @unique
  password       String?
  telegramChatId String?
  percentage     Float    @default(0) // Revenue share percentage
  clinicId       String
  clinic         Clinic   @relation(fields: [clinicId], references: [id])
  appointments   Appointment[]
  
  @@unique([clinicId, telegramChatId])
}

model Patient {
  id             String        @id @default(uuid())
  firstName      String
  lastName       String
  phone          String
  dob            String
  lastVisit      String
  status         String // 'Active' | 'Archived'
  gender         String // 'Male' | 'Female'
  medicalHistory String
  address        String? // Optional address
  telegramChatId String?
  clinicId       String
  clinic         Clinic        @relation(fields: [clinicId], references: [id])
  appointments   Appointment[]
  diagnoses      PatientDiagnosis[]
  
  @@unique([clinicId, telegramChatId])
  @@index([phone]) // Optimize phone lookup
  photos         PatientPhoto[]
  teeth          ToothData[]
  transactions   Transaction[]
  inventoryLogs  InventoryLog[]
}

model ToothData {
  id          Int      @id @default(autoincrement())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  number      Int
  conditions  String   // JSON string of ToothStatus[]
  notes       String?
  updatedAt   DateTime @updatedAt

  @@unique([patientId, number])
}

model PatientPhoto {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  url         String   // Path to the file
  description String?
  category    String   // 'Before', 'After', 'X-Ray', 'Other'
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
}

model Appointment {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  patientName String
  doctorId    String
  doctor      Doctor   @relation(fields: [doctorId], references: [id])
  doctorName  String
  type        String
  date        String
  time        String
  duration    Int
  status      String // 'Confirmed' | 'Pending' | 'Completed' | 'Cancelled' | 'No-Show' | 'Checked-In'
  reminderSent Boolean @default(false)
  notes       String?
  clinicId    String
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
}

model Transaction {
  id          String   @id @default(uuid())
  patientName String
  date        String
  amount      Float
  type        String // 'Cash' | 'Card' | 'Insurance'
  service     String
  status      String // 'Paid' | 'Pending' | 'Overdue'
  doctorId    String?  // Optional - for backward compatibility
  doctorName  String?  // Optional - for backward compatibility
  patientId   String?  // Optional initially to support existing data
  patient     Patient? @relation(fields: [patientId], references: [id])
  clinicId    String
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
}

model Service {
  id       Int    @id @default(autoincrement())
  name     String
  price    Float
  cost     Float  @default(0) // Service cost (e.g., technician fee)
  duration Int
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])
}

model SubscriptionPlan {
  id         String   @id
  name       String
  price      Float
  maxDoctors Int
  features   String // Stored as JSON string or comma-separated
  clinics    Clinic[]
}

model Clinic {
  id                    String           @id @default(uuid())
  name                  String
  adminName             String
  username              String           @unique
  password              String?
  phone                 String
  status                String // 'Active' | 'Blocked' | 'Pending'
  telegramChatId        String?
  botToken              String? // Token for the clinic's own bot
  planId                String
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])
  subscriptionStartDate String
  expiryDate            String
  monthlyRevenue        Float
  subscriptionType      String           @default("Paid") // 'Paid' | 'Trial'

  // Relations
  doctors       Doctor[]
  patients      Patient[]
  appointments  Appointment[]
  transactions  Transaction[]
  services      Service[]
  diagnoses     PatientDiagnosis[]
  inventoryItems InventoryItem[]

  @@index([botToken]) // Optimize bot startup
}

model ICD10Code {
  code        String             @id
  name        String
  category    String?            // New field for grouping
  description String?
  diagnoses   PatientDiagnosis[]
}

model PatientDiagnosis {
  id          String    @id @default(uuid())
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id])
  code        String
  icd10       ICD10Code @relation(fields: [code], references: [code])
  date        String
  notes       String?
  status      String // 'Active' | 'Resolved' | 'Chronic'
  clinicId    String
  clinic      Clinic    @relation(fields: [clinicId], references: [id])
}

model InventoryItem {
  id          String         @id @default(uuid())
  name        String
  unit        String         // e.g., 'pcs', 'mg', 'ml'
  quantity    Float          @default(0)
  minQuantity Float          @default(0) // Minimum stock level for alerts
  clinicId    String
  clinic      Clinic         @relation(fields: [clinicId], references: [id])
  logs        InventoryLog[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model InventoryLog {
  id        String        @id @default(uuid())
  itemId    String
  item      InventoryItem @relation(fields: [itemId], references: [id])
  change    Float         // Positive for IN, negative for OUT
  type      String        // 'IN' | 'OUT'
  note      String?
  date      DateTime      @default(now())
  userName  String        // Who made the change
  patientId String?
  patient   Patient?      @relation(fields: [patientId], references: [id])
  
  @@index([itemId])
  @@index([patientId])
}
